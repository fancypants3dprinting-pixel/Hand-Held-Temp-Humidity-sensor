#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_BME280.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// ---------- BME280 ----------
#define BME280_ADDRESS 0x76  
Adafruit_BME280 bme;

#define SEALEVELPRESSURE_HPA (1018.0)

// ---------- OLED ----------
#define SCREEN_WIDTH 128
#define SCREEN_HEIGHT 64
#define OLED_ADDR 0x3C
Adafruit_SSD1306 display(SCREEN_WIDTH, SCREEN_HEIGHT, &Wire, -1);

// ---------- I2C PINS (ESP32 default) ----------
#define I2C_SDA 21
#define I2C_SCL 22



unsigned long lastReadMs = 0;
const unsigned long readIntervalMs = 2000;
int readAttempts = 0;
int successfulReads = 0;
int failedReads = 0;

// Display mode: 0 = Temp/Humidity, 1 = Pressure/Altitude, 2 = Dew Point/Heat Index
int displayMode = 0;
unsigned long lastModeChange = 0;
const unsigned long modeChangeInterval = 8000; // Switch every 8 seconds

void setup() {
  Serial.begin(115200);
  delay(500);
  
  Serial.println("\n\n==================================");
  Serial.println("ESP32 + BME280 + OLED DIAGNOSTICS");
  Serial.println("==================================\n");
  

  // Start I2C
  Wire.begin(I2C_SDA, I2C_SCL);
  Serial.print("I2C initialized on SDA=");
  Serial.print(I2C_SDA);
  Serial.print(", SCL=");
  Serial.println(I2C_SCL);
  
  // Start OLED
  Serial.print("Initializing OLED at address 0x");
  Serial.print(OLED_ADDR, HEX);
  Serial.print("...");
  
  if (!display.begin(SSD1306_SWITCHCAPVCC, OLED_ADDR)) {
    Serial.println(" FAILED!");
    Serial.println("ERROR: OLED not found. Check:");
    Serial.println("  - Wiring (SDA to GPIO21, SCL to GPIO22)");
    Serial.println("  - OLED address (try 0x3D if 0x3C fails)");
    Serial.println("  - Power connections");
    while (true) delay(100);
  }
  Serial.println(" SUCCESS!");
  
  // Initialize display settings
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.display();
  delay(100);
  
  // startup animation with FP and orbiting ball
  for (int frame = 0; frame < 120; frame++) {
    display.clearDisplay();
    display.setTextColor(SSD1306_WHITE);
    
    // Draw large FP letters in center
    display.setTextSize(4);
    display.setCursor(44, 12);
    display.print("FP");
    
    // Draw "PORTABLE ELECTRONICS" text below FP
    display.setTextSize(1);
    display.setCursor(40, 48);
    display.print("PORTABLE");
    display.setCursor(30, 56);
    display.print("ELECTRONICS");
    
    int centerX = 64;
    int centerY = 28;
    
    // Single ball - elliptical orbit (horizontal/side to side)
    float angle = (frame / 120.0) * 2.0 * PI;
    int ellipseRadiusX = 40; // Wider horizontally
    int ellipseRadiusY = 20; // Narrower vertically (creates side-to-side illusion)
    int ballX = centerX + (int)(ellipseRadiusX * cos(angle));
    int ballY = centerY + (int)(ellipseRadiusY * sin(angle));
    
    // Draw trailing path behind the ball
    for (int trail = 1; trail <= 30; trail++) {
      float trailAngle = ((frame - trail) / 120.0) * 2.0 * PI;
      int trailX = centerX + (int)(ellipseRadiusX * cos(trailAngle));
      int trailY = centerY + (int)(ellipseRadiusY * sin(trailAngle));
      display.drawPixel(trailX, trailY, SSD1306_WHITE);
    }
    
    // Draw orbiting ball
    display.fillCircle(ballX, ballY, 3, SSD1306_WHITE);
    
    display.display();
    delay(25); // Smooth animation
  }
  
  // Transition screen
  delay(500);
  display.clearDisplay();
  display.setTextColor(SSD1306_WHITE);
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("ESP32 Diagnostics");
  display.println("Testing BME280...");
  display.display();
  delay(1000);
  
  // Initialize BME280
  Serial.println("\nInitializing BME280 sensor...");
  Serial.print("Trying address 0x");
  Serial.print(BME280_ADDRESS, HEX);
  Serial.print("...");
  
  if (!bme.begin(BME280_ADDRESS)) {
    Serial.println(" FAILED!");
    Serial.println("ERROR: BME280 not found. Troubleshooting:");
    Serial.println("  - Check wiring (SDA to GPIO21, SCL to GPIO22)");
    Serial.println("  - Try address 0x77 if using 0x76");
    Serial.println("  - Verify BME280 has power (3.3V and GND)");
    Serial.println("  - Check if module is BME280 (not BMP280)");
    
    display.clearDisplay();
    display.setCursor(0, 0);
    display.println("BME280 ERROR!");
    display.println("");
    display.println("Check wiring");
    display.println("Try addr 0x77");
    display.display();
    
    while (true) delay(100);
  }
  Serial.println(" SUCCESS!");
  
  // Configure BME280 settings
  bme.setSampling(Adafruit_BME280::MODE_NORMAL,
                  Adafruit_BME280::SAMPLING_X2,  // temperature
                  Adafruit_BME280::SAMPLING_X16, // pressure
                  Adafruit_BME280::SAMPLING_X1,  // humidity
                  Adafruit_BME280::FILTER_X16,
                  Adafruit_BME280::STANDBY_MS_500);
  
  delay(1000);
  Serial.println("BME280 initialized successfully!");
  Serial.println("\n--- Starting continuous monitoring ---\n");
}

// Calculate Dew Point using Magnus formula
float calculateDewPoint(float tempC, float humidity) {
  float a = 17.27;
  float b = 237.7;
  float alpha = ((a * tempC) / (b + tempC)) + log(humidity / 100.0);
  float dewPoint = (b * alpha) / (a - alpha);
  return dewPoint;
}

// Calculate Heat Index (Feels Like temperature)
float calculateHeatIndex(float tempF, float humidity) {
  // Only calculate if temp > 80°F, otherwise return actual temp
  if (tempF < 80) {
    return tempF;
  }
  
  // Rothfusz regression
  float hi = -42.379 + 
             2.04901523 * tempF + 
             10.14333127 * humidity - 
             0.22475541 * tempF * humidity - 
             0.00683783 * tempF * tempF - 
             0.05481717 * humidity * humidity + 
             0.00122874 * tempF * tempF * humidity + 
             0.00085282 * tempF * humidity * humidity - 
             0.00000199 * tempF * tempF * humidity * humidity;
  
  return hi;
}



void drawScreen(float tempF, float tempC, float hum, float pressureHpa, float altMeters, 
                float dewPointF, float heatIndexF, bool sensorError) {
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("ESP32  |  BME280");
  display.drawLine(0, 12, 127, 12, SSD1306_WHITE);
  
  if (sensorError) {
    display.setTextSize(2);
    display.setCursor(0, 18);
    display.println("BME Err");
    display.setTextSize(1);
    display.setCursor(0, 46);
    display.println("Check wiring!");
    
    // Vertical reads counter on right side
    display.setCursor(110, 18);
    display.print(successfulReads);
    display.setCursor(110, 26);
    display.print("/");
    display.setCursor(110, 34);
    display.print(readAttempts);
  } else {
    if (displayMode == 0) {
      // Screen 1: Temperature and Humidity
      display.setTextSize(2);
      display.setCursor(0, 18);
      display.print("T:");
      display.print(tempF, 1);
      display.println("F");
      display.print("H:");
      display.print(hum, 1);
      display.println("%");
      
    } else if (displayMode == 1) {
      // Screen 2: Pressure and Altitude
      display.setTextSize(1);
      display.setCursor(0, 18);
      display.println("Pressure:");
      display.setTextSize(2);
      display.print(pressureHpa, 1);
      display.setTextSize(1);
      display.println(" hPa");
      
      display.println("");
      display.println("Altitude:");
      display.setTextSize(2);
      display.print(altMeters * 3.28084, 0); // Convert to feet
      display.setTextSize(1);
      display.println(" ft");
      
    } else {
      // Screen 3: Dew Point and Heat Index (Feels Like)
      display.setTextSize(1);
      display.setCursor(0, 18);
      display.println("Dew Point:");
      display.setTextSize(2);
      display.print(dewPointF, 1);
      display.setTextSize(1);
      display.println(" F");
      
      display.println("");
      display.println("Feels Like:");
      display.setTextSize(2);
      display.print(heatIndexF, 1);
      display.setTextSize(1);
      display.println(" F");
    }
    
    // Vertical reads counter on right side
    display.setTextSize(1);
    display.setCursor(110, 18);
    display.print(successfulReads);
    display.setCursor(110, 26);
    display.print("/");
    display.setCursor(110, 34);
    display.print(readAttempts);
  }
  
  display.display();
}

void loop() {
  // Auto-switch display mode (3 screens now)
  if (millis() - lastModeChange >= modeChangeInterval) {
    lastModeChange = millis();
    displayMode = (displayMode + 1) % 3; // Cycle through 0, 1, 2
  }
  
  if (millis() - lastReadMs >= readIntervalMs) {
    lastReadMs = millis();
    readAttempts++;
    
    Serial.println("========================================");
    Serial.print("Read Attempt #");
    Serial.println(readAttempts);
    Serial.println("========================================");
    
    // Read sensor
    Serial.println("Reading BME280...");
    float tempC = bme.readTemperature();
    float tempF = (tempC * 9.0 / 5.0) + 32.0;
    float hum = bme.readHumidity();
    float pressureHpa = bme.readPressure() / 100.0F;
    float altMeters = bme.readAltitude(SEALEVELPRESSURE_HPA);
    
    // Calculate derived values
    float dewPointC = calculateDewPoint(tempC, hum);
    float dewPointF = (dewPointC * 9.0 / 5.0) + 32.0;
    float heatIndexF = calculateHeatIndex(tempF, hum);
    
    // Debug raw values
    Serial.print("  Temperature: ");
    Serial.print(tempF, 2);
    Serial.println("°F");
    
    Serial.print("  Humidity: ");
    Serial.print(hum, 2);
    Serial.println("%");
    
    Serial.print("  Pressure: ");
    Serial.print(pressureHpa, 2);
    Serial.println(" hPa");
    
    Serial.print("  Altitude: ");
    Serial.print(altMeters, 2);
    Serial.print(" m (");
    Serial.print(altMeters * 3.28084, 2);
    Serial.println(" ft)");
    
    Serial.print("  Dew Point: ");
    Serial.print(dewPointF, 2);
    Serial.println("°F");
    
    Serial.print("  Heat Index (Feels Like): ");
    Serial.print(heatIndexF, 2);
    Serial.println("°F");
    
    // Check for errors (BME280 returns valid ranges)
    bool tempError = (tempC < -40 || tempC > 85);
    bool humError = (hum < 0 || hum > 100);
    bool pressError = (pressureHpa < 300 || pressureHpa > 1100);
    
    if (tempError) {
      Serial.println("  ❌ ERROR: Temperature out of range");
    } else {
      Serial.print("  ✓ Temperature OK: ");
      Serial.print(tempF, 1);
      Serial.println("°F");
    }
    
    if (humError) {
      Serial.println("  ❌ ERROR: Humidity out of range");
    } else {
      Serial.print("  ✓ Humidity OK: ");
      Serial.print(hum, 1);
      Serial.println("%");
    }
    
    if (pressError) {
      Serial.println("  ❌ ERROR: Pressure out of range");
    } else {
      Serial.print("  ✓ Pressure OK: ");
      Serial.print(pressureHpa, 1);
      Serial.println(" hPa");
    }
    
    // Overall status
    if (tempError || humError || pressError) {
      failedReads++;
      Serial.println("\n⚠ SENSOR READ FAILED");
      Serial.println("\nTroubleshooting steps:");
      Serial.println("1. Check BME280 wiring:");
      Serial.println("   - VCC to 3.3V");
      Serial.println("   - SDA to GPIO 21");
      Serial.println("   - SCL to GPIO 22");
      Serial.println("   - GND to GND");
      Serial.println("2. Verify I2C address (0x76 or 0x77)");
      Serial.println("3. Check if module is BME280 (not BMP280)");
      Serial.print("\nSuccess rate: ");
      Serial.print(successfulReads);
      Serial.print("/");
      Serial.print(readAttempts);
      Serial.print(" (");
      if (readAttempts > 0) {
        Serial.print((successfulReads * 100) / readAttempts);
      }
      Serial.println("%)");
      
      drawScreen(tempF, tempC, hum, pressureHpa, altMeters, dewPointF, heatIndexF, true);
    } else {
      successfulReads++;
      Serial.println("\n✓ SENSOR READ SUCCESSFUL");
      Serial.print("Success rate: ");
      Serial.print(successfulReads);
      Serial.print("/");
      Serial.print(readAttempts);
      Serial.print(" (");
      Serial.print((successfulReads * 100) / readAttempts);
      Serial.println("%)");
      
      drawScreen(tempF, tempC, hum, pressureHpa, altMeters, dewPointF, heatIndexF, false);
    }
    
    Serial.println("========================================\n");
  }
}
